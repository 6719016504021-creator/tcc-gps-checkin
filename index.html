<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ระบบเช็คชื่อ GPS - วิทยาลัยชุมชนเทพา</title>
    
    <!-- Google Fonts: Sarabun -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Leaflet.js -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Leaflet Draw -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

    <!-- Turf.js -->
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            overflow-x: hidden; 
            overflow-y: auto;
            min-height: 100vh;
        }

        #app { transition: all 0.3s ease-in-out; }
        
        @media (max-width: 640px) {
            body { background: #f8fafc; padding: 0; }
            #app { width: 100%; min-height: 100vh; border-radius: 0; box-shadow: none; margin: 0; }
            header { border-radius: 0 !important; padding-top: max(1.5rem, env(safe-area-inset-top)); }
            main { border-radius: 0 !important; padding-bottom: 80px; }
        }

        .glass-container {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.6);
        }
        @media (max-width: 640px) {
             .glass-container { background: #f8fafc; backdrop-filter: none; border: none; }
        }

        .bg-gradient-brand { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .text-brand { color: #764ba2; }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .blob { position: absolute; filter: blur(60px); opacity: 0.6; animation: float 10s infinite ease-in-out alternate; z-index: -1; }
        .blob-1 { top: -10%; left: -10%; width: 50vw; height: 50vw; background: #a18cd1; animation-duration: 12s; }
        .blob-2 { bottom: -10%; right: -10%; width: 50vw; height: 50vw; background: #fbc2eb; animation-duration: 15s; }
        @keyframes float { 0% { transform: translate(0, 0); } 100% { transform: translate(20px, 40px); } }

        #map-teacher { height: 350px; width: 100%; border-radius: 0.75rem; z-index: 1; }
        
        .force-show { display: flex !important; }
        .force-hide { display: none !important; }
        
        .mobile-bottom-nav { display: none; }
        @media (max-width: 640px) {
            .mobile-bottom-nav { display: flex; position: fixed; bottom: 0; left: 0; width: 100%; background: white; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 50; padding-bottom: env(safe-area-inset-bottom); }
            .desktop-nav { display: none; }
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center text-gray-800 relative py-0 sm:py-8">

    <div class="fixed inset-0 overflow-hidden pointer-events-none -z-10 hidden sm:block">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
    </div>

    <div id="app" class="w-full max-w-md md:max-w-4xl glass-container md:rounded-3xl shadow-2xl relative flex flex-col transition-all duration-500 my-auto min-h-screen sm:min-h-[800px]">
        
        <header class="bg-gradient-brand text-white p-4 sm:p-6 text-center shadow-md z-10 relative overflow-hidden md:rounded-t-3xl flex-shrink-0">
            <div class="absolute top-0 left-0 w-full h-full bg-white opacity-10 transform -skew-x-12 translate-x-full animate-[shimmer_3s_infinite]"></div>
            <div class="relative z-10 flex flex-col items-center">
                <h1 class="text-xl sm:text-2xl font-bold flex items-center gap-2"><i class="fa-solid fa-location-dot animate-bounce"></i> วิทยาลัยชุมชนเทพา</h1>
                <p class="text-xs sm:text-sm opacity-90 mt-1">ระบบเช็คชื่อด้วย GPS อัจฉริยะ</p>
            </div>
        </header>

        <main id="main-content" class="flex-1 p-4 sm:p-6 relative bg-white/50 backdrop-blur-sm md:rounded-b-3xl overflow-y-auto custom-scrollbar">
            
            <!-- 1. Landing Page -->
            <div id="page-landing" class="flex flex-col items-center justify-center gap-6 animate-fade-in w-full h-full min-h-[500px]">
                <div class="text-center mb-6">
                    <div class="relative inline-block group mb-4">
                        <div class="absolute inset-0 bg-purple-400 rounded-full blur opacity-20 animate-pulse"></div>
                        <img id="app-logo" src="https://upload.wikimedia.org/wikipedia/commons/thumb/c/cb/Seal_of_the_Institute_of_Community_Colleges_of_Thailand.svg/480px-Seal_of_the_Institute_of_Community_Colleges_of_Thailand.svg.png" onerror="this.src='https://placehold.co/150x150/667eea/ffffff?text=Logo'" class="w-32 h-32 sm:w-44 sm:h-44 mx-auto drop-shadow-2xl object-contain filter p-3 bg-white/80 rounded-full border border-white/50">
                    </div>
                    <h2 class="text-lg sm:text-xl font-bold text-gray-700 px-4">ยินดีต้อนรับเข้าสู่ระบบเช็คชื่อ</h2>
                    <p class="text-gray-500 text-sm mt-1">กรุณาเลือกประเภทผู้ใช้งาน</p>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 w-full max-w-2xl px-4">
                    <button onclick="router.navigateTo('student-auth')" class="bg-white border-2 border-indigo-100 p-5 rounded-2xl shadow-md hover:shadow-xl hover:border-indigo-500 transition-all group flex items-center w-full">
                        <div class="bg-indigo-100 p-4 rounded-xl text-indigo-600 group-hover:bg-indigo-600 group-hover:text-white transition-colors"><i class="fa-solid fa-user-graduate text-2xl"></i></div>
                        <div class="ml-4 text-left flex-1"><h3 class="font-bold text-lg text-gray-800">นักศึกษา</h3><p class="text-xs text-gray-500">ลงทะเบียน / เช็คชื่อ</p></div>
                        <i class="fa-solid fa-chevron-right text-gray-300 group-hover:text-indigo-500"></i>
                    </button>
                    <button onclick="router.navigateTo('teacher-login')" class="bg-white border-2 border-purple-100 p-5 rounded-2xl shadow-md hover:shadow-xl hover:border-purple-500 transition-all group flex items-center w-full">
                        <div class="bg-purple-100 p-4 rounded-xl text-purple-600 group-hover:bg-purple-600 group-hover:text-white transition-colors"><i class="fa-solid fa-chalkboard-user text-2xl"></i></div>
                        <div class="ml-4 text-left flex-1"><h3 class="font-bold text-lg text-gray-800">อาจารย์</h3><p class="text-xs text-gray-500">จัดการข้อมูล / รายงาน</p></div>
                        <i class="fa-solid fa-chevron-right text-gray-300 group-hover:text-purple-500"></i>
                    </button>
                </div>
            </div>

            <!-- 2. Student Register -->
            <div id="page-student-register" class="force-hide flex-col justify-center items-center w-full py-6 relative z-50 min-h-full">
                <div class="bg-white p-6 sm:p-8 rounded-3xl shadow-xl border border-gray-100 w-full max-w-sm mx-auto">
                    <div class="text-center mb-6">
                        <div class="w-14 h-14 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center mx-auto mb-3 text-xl"><i class="fa-solid fa-user-plus"></i></div>
                        <h2 class="text-xl font-bold text-gray-800">ลงทะเบียนนักศึกษา</h2>
                    </div>
                    <form onsubmit="studentApp.register(event)" class="space-y-4">
                        <div class="group relative">
                            <label class="block text-gray-700 text-xs font-bold mb-1 ml-1">รหัสนักศึกษา</label>
                            <div class="relative"><i class="fa-solid fa-id-card absolute left-3 top-3.5 text-gray-400 z-10"></i><input type="text" id="reg-id" required class="w-full pl-10 pr-3 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-gray-50 text-sm" placeholder="เช่น 6601234"></div>
                        </div>
                        <div class="group relative">
                            <label class="block text-gray-700 text-xs font-bold mb-1 ml-1">ชื่อ - นามสกุล</label>
                            <div class="relative"><i class="fa-solid fa-user absolute left-3 top-3.5 text-gray-400 z-10"></i><input type="text" id="reg-name" required class="w-full pl-10 pr-3 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-gray-50 text-sm" placeholder="เช่น สมชาย ใจดี"></div>
                        </div>
                        <div class="group relative">
                            <label class="block text-gray-700 text-xs font-bold mb-1 ml-1">สาขาวิชา</label>
                            <div class="relative"><i class="fa-solid fa-graduation-cap absolute left-3 top-3.5 text-gray-400 z-10"></i><input type="text" id="reg-major" required class="w-full pl-10 pr-3 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-gray-50 text-sm" placeholder="ระบุสาขาวิชา..."></div>
                        </div>
                        <button type="submit" class="w-full bg-gradient-brand text-white font-bold py-3.5 rounded-xl hover:opacity-90 shadow-md mt-4">ลงทะเบียน</button>
                        <button type="button" onclick="router.navigateTo('landing')" class="w-full mt-4 text-gray-500 text-sm hover:text-gray-800 text-center flex items-center justify-center gap-2 py-2"><i class="fa-solid fa-arrow-left"></i> ย้อนกลับ</button>
                    </form>
                </div>
            </div>

            <!-- 3. Student Dashboard -->
            <div id="page-student-dashboard" class="force-hide flex-col pb-24 w-full">
                <!-- Dashboard Content -->
                <div class="bg-gradient-to-br from-violet-600 to-indigo-700 p-5 rounded-2xl shadow-lg mb-6 text-white relative overflow-hidden">
                     <div class="flex justify-between items-start relative z-10">
                        <div>
                            <p class="text-indigo-200 text-xs mb-1 font-medium">ยินดีต้อนรับ,</p>
                            <h2 id="st-dash-name" class="text-xl sm:text-2xl font-bold tracking-tight mb-1 truncate max-w-[200px]">...</h2>
                            <div class="flex items-center gap-2"><span class="bg-white/20 px-2 py-0.5 rounded text-[10px] backdrop-blur-sm border border-white/10"><i class="fa-solid fa-id-card-clip mr-1"></i> <span id="st-dash-id">...</span></span></div>
                        </div>
                        <div id="gps-status-badge" class="bg-white/20 backdrop-blur-md border border-white/30 px-3 py-1 rounded-full text-[10px] font-bold shadow-sm animate-pulse flex items-center gap-1"><i class="fa-solid fa-satellite-dish"></i> <span>ค้นหา...</span></div>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-2 sm:gap-4 mb-6">
                    <div id="box-dist" class="bg-white p-2 sm:p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center text-center">
                        <i class="fa-solid fa-route text-blue-500 text-lg mb-1"></i><div class="text-[10px] text-gray-400">ระยะห่าง</div><div id="st-dist" class="font-bold text-gray-800 text-xs sm:text-sm">-</div>
                    </div>
                    <div class="bg-white p-2 sm:p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center text-center">
                        <i class="fa-solid fa-satellite text-purple-500 text-lg mb-1"></i><div class="text-[10px] text-gray-400">ความแม่นยำ</div><div id="st-acc" class="font-bold text-gray-800 text-xs sm:text-sm">-</div>
                    </div>
                    <div id="box-status" class="bg-white p-2 sm:p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center text-center">
                        <i id="icon-status" class="fa-solid fa-location-dot text-gray-400 text-lg mb-1"></i><div class="text-[10px] text-gray-400">สถานะ</div><div id="st-status-text" class="font-bold text-gray-400 text-xs sm:text-sm">รอพิกัด...</div>
                    </div>
                </div>

                <!-- FIX: Added 'disabled' attribute to prevent early clicks -->
                <button id="btn-checkin" onclick="studentApp.checkIn()" disabled class="w-full py-5 rounded-2xl bg-gray-200 text-gray-400 font-bold text-lg shadow-inner mb-6 transition-all transform active:scale-95 flex flex-col items-center justify-center gap-1 disabled:cursor-not-allowed">
                    <i class="fa-solid fa-fingerprint text-3xl"></i><span>กำลังค้นหา GPS...</span>
                </button>

                <div class="grid grid-cols-2 gap-3 sm:gap-4 mb-6">
                    <button onclick="studentApp.openLeaveModal()" class="bg-orange-50 p-3 sm:p-4 rounded-xl border border-orange-100 hover:bg-orange-100 transition-all flex flex-col items-center justify-center text-center gap-2">
                        <i class="fa-solid fa-envelope-open-text text-xl text-orange-500"></i><div><div class="font-bold text-orange-700 text-sm">ลาเรียน</div><div class="text-[10px] text-orange-400">แจ้งลาป่วย/กิจ</div></div>
                    </button>
                    <button id="btn-reset-account" onclick="studentApp.resetAccount()" class="bg-gray-50 p-3 sm:p-4 rounded-xl border border-gray-200 hover:bg-gray-100 transition-all flex flex-col items-center justify-center text-center gap-2">
                        <i class="fa-solid fa-rotate-right text-xl text-gray-500"></i><div><div class="font-bold text-gray-700 text-sm">รีเซตบัญชี</div><div class="text-[10px] text-gray-400">ลงทะเบียนใหม่</div></div>
                    </button>
                </div>

                <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col sm:flex-row items-center gap-4">
                    <div class="w-full sm:w-1/3 h-32 relative flex items-center justify-center">
                        <canvas id="studentStatChart"></canvas>
                        <div class="absolute inset-0 flex items-center justify-center flex-col pointer-events-none">
                            <span class="text-[10px] text-gray-400">รวม</span><span class="text-lg font-bold text-gray-700" id="stat-chart-total">0</span>
                        </div>
                    </div>
                    <div class="w-full sm:w-2/3 grid grid-cols-2 gap-3">
                        <div class="bg-green-50 p-2 rounded-lg text-center"><span class="text-xs text-green-600 block">ทันเวลา</span><span id="stat-present" class="text-lg font-bold text-green-700">0</span></div>
                        <div class="bg-yellow-50 p-2 rounded-lg text-center"><span class="text-xs text-yellow-600 block">สาย</span><span id="stat-late" class="text-lg font-bold text-yellow-700">0</span></div>
                        <div class="bg-orange-50 p-2 rounded-lg text-center"><span class="text-xs text-orange-600 block">ลา</span><span id="stat-leave" class="text-lg font-bold text-orange-700">0</span></div>
                        <div class="bg-red-50 p-2 rounded-lg text-center"><span class="text-xs text-red-600 block">ขาด</span><span id="stat-absent" class="text-lg font-bold text-red-700">0</span></div>
                    </div>
                </div>
                <div class="mt-8 text-center pb-8"><button onclick="router.navigateTo('landing')" class="text-gray-400 hover:text-gray-600 text-sm underline">ออกจากหน้าจอ</button></div>
            </div>

            <!-- 4. Teacher Login -->
            <div id="page-teacher-login" class="force-hide flex-col justify-center items-center w-full py-10 relative z-50">
                <div class="bg-white p-6 sm:p-8 rounded-3xl shadow-xl border border-gray-100 w-full max-w-sm">
                    <h2 class="text-2xl font-bold text-brand mb-6 text-center">สำหรับอาจารย์</h2>
                    <form onsubmit="teacherApp.login(event)" class="space-y-4">
                        <div class="group relative">
                            <label class="block text-gray-700 text-xs font-bold mb-1 uppercase">Username</label>
                            <input type="text" id="t-user" required class="w-full pl-3 pr-3 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 bg-gray-50 text-sm">
                        </div>
                        <div class="group relative">
                            <label class="block text-gray-700 text-xs font-bold mb-1 uppercase">Password</label>
                            <input type="password" id="t-pass" required class="w-full pl-3 pr-3 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 bg-gray-50 text-sm">
                        </div>
                        <button type="submit" class="w-full bg-gray-800 text-white font-bold py-3.5 rounded-xl hover:bg-gray-700 transition shadow-lg mt-6">เข้าสู่ระบบ</button>
                        <button type="button" onclick="router.navigateTo('landing')" class="w-full mt-4 text-gray-500 text-sm hover:text-gray-800 text-center flex items-center justify-center gap-2"><i class="fa-solid fa-arrow-left"></i> ย้อนกลับ</button>
                    </form>
                </div>
            </div>

            <!-- 5. Teacher Dashboard -->
            <div id="page-teacher-dashboard" class="force-hide flex-col w-full h-full pb-20">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg sm:text-xl font-bold text-gray-800">แดชบอร์ดอาจารย์</h2>
                    <button onclick="teacherApp.logout()" class="text-red-500 text-xs sm:text-sm font-bold bg-red-50 px-3 py-1.5 rounded-lg hover:bg-red-100"><i class="fa-solid fa-right-from-bracket mr-1"></i> ออก</button>
                </div>
                
                <div class="desktop-nav flex space-x-1 bg-white p-1 rounded-xl mb-4 text-sm overflow-x-auto no-scrollbar border border-gray-200 shadow-sm sticky top-0 z-20">
                    <button onclick="teacherApp.switchTab('overview')" class="tab-btn flex-1 py-2 px-3 rounded-lg font-medium transition-all duration-300 whitespace-nowrap" data-tab="overview">ภาพรวม</button>
                    <button onclick="teacherApp.switchTab('students')" class="tab-btn flex-1 py-2 px-3 rounded-lg font-medium transition-all duration-300 whitespace-nowrap" data-tab="students">นศ.</button>
                    <button onclick="teacherApp.switchTab('leaves')" class="tab-btn flex-1 py-2 px-3 rounded-lg font-medium transition-all duration-300 whitespace-nowrap relative" data-tab="leaves">คำร้อง <span id="badge-leave-count" class="hidden absolute top-0 right-0 -mt-1 -mr-1 w-2.5 h-2.5 bg-red-500 rounded-full animate-pulse"></span></button>
                    <button onclick="teacherApp.switchTab('search')" class="tab-btn flex-1 py-2 px-3 rounded-lg font-medium transition-all duration-300 whitespace-nowrap" data-tab="search">ค้นหา</button>
                    <button onclick="teacherApp.switchTab('settings')" class="tab-btn flex-1 py-2 px-3 rounded-lg font-medium transition-all duration-300 text-gray-600 whitespace-nowrap" data-tab="settings"><i class="fa-solid fa-gear"></i> ตั้งค่า</button>
                </div>

                <div id="tab-overview" class="tab-content w-full space-y-4">
                    <div class="flex gap-2">
                         <button onclick="teacherApp.openSheet()" class="flex-1 bg-white text-green-600 border border-green-200 px-3 py-2 rounded-xl text-xs font-bold hover:bg-green-50 shadow-sm flex items-center justify-center gap-1"><i class="fa-brands fa-google-drive"></i> เปิด Sheets</button>
                         <button onclick="teacherApp.exportToCSV()" class="flex-1 bg-green-600 text-white px-3 py-2 rounded-xl text-xs font-bold hover:bg-green-700 shadow-sm flex items-center justify-center gap-1"><i class="fa-solid fa-download"></i> โหลด CSV</button>
                    </div>
                    <div class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 flex flex-wrap gap-2 items-center">
                         <select id="overview-filter-major" onchange="teacherApp.loadOverview()" class="bg-gray-50 border-none text-xs rounded-lg p-2 flex-1 min-w-[120px]"><option value="all">ทุกสาขา</option></select>
                         <select id="filter-type" onchange="teacherApp.toggleFilterType()" class="bg-gray-50 border-none text-xs rounded-lg p-2 w-auto"><option value="daily">รายวัน</option><option value="monthly">รายเดือน</option></select>
                         <input type="date" id="filter-date" class="bg-gray-50 border-none text-xs rounded-lg p-2 flex-1 min-w-[120px]" onchange="teacherApp.loadOverview()">
                         <input type="month" id="filter-month" class="bg-gray-50 border-none text-xs rounded-lg p-2 flex-1 min-w-[120px] hidden" onchange="teacherApp.loadOverview()">
                         <input type="number" id="filter-year" class="bg-gray-50 border-none text-xs rounded-lg p-2 flex-1 min-w-[120px] hidden" onchange="teacherApp.loadOverview()" placeholder="ปี ค.ศ.">
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-gradient-to-br from-purple-600 to-indigo-600 p-4 rounded-2xl text-white shadow-md"><h3 class="text-xs opacity-80" id="overview-count-title">วันนี้</h3><div class="text-2xl font-bold mt-1" id="overview-today-count">0</div><div class="text-[10px]">คน (เช็คชื่อ)</div></div>
                        <div class="bg-gradient-to-br from-blue-500 to-cyan-500 p-4 rounded-2xl text-white shadow-md"><h3 class="text-xs opacity-80">ทั้งหมด</h3><div class="text-2xl font-bold mt-1" id="overview-total-count">0</div><div class="text-[10px]">คน (ลงทะเบียน)</div></div>
                    </div>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                            <h3 class="text-xs font-bold text-gray-500 mb-2">กราฟการเข้าเรียน</h3>
                            <div class="h-32 relative w-full"><canvas id="attendanceChart"></canvas></div>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                            <h3 class="text-xs font-bold text-gray-500 mb-2">สัดส่วน</h3>
                            <div class="h-32 relative flex justify-center"><canvas id="overviewPieChart"></canvas></div>
                        </div>
                    </div>
                </div>

                <div id="tab-students" class="tab-content hidden w-full bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                     <div class="p-3 bg-gray-50 border-b border-gray-100 flex flex-col sm:flex-row justify-between items-center gap-2">
                         <h3 class="font-bold text-sm text-gray-700 flex items-center gap-2"><i class="fa-solid fa-users text-indigo-500"></i> รายชื่อนักศึกษา</h3>
                         <div class="flex gap-2 w-full sm:w-auto">
                             <input type="month" id="student-filter-month" class="text-xs border border-gray-300 rounded-lg p-1.5 bg-white" onchange="teacherApp.loadStudents()">
                             <select id="student-filter-major" onchange="teacherApp.loadStudents()" class="text-xs border border-gray-300 rounded-lg p-1.5 bg-white"><option value="all">ทุกสาขาวิชา</option></select>
                         </div>
                     </div>
                     <div class="overflow-x-auto max-h-[60vh]">
                        <table class="w-full text-xs text-left">
                            <thead class="bg-white text-gray-500 sticky top-0 z-10 shadow-sm">
                                <tr>
                                    <th class="px-4 py-3 bg-gray-50">ชื่อ-สกุล / รหัส</th>
                                    <th class="px-2 py-3 text-center bg-gray-50">สถิติ (เดือนนี้)</th>
                                    <th class="px-4 py-3 text-right bg-gray-50">จัดการ</th>
                                </tr>
                            </thead>
                            <tbody id="student-list-body" class="divide-y divide-gray-50"></tbody>
                        </table>
                     </div>
                </div>

                <div id="tab-leaves" class="tab-content hidden w-full space-y-4">
                    <h3 class="font-bold text-gray-700 px-2 text-sm border-l-4 border-orange-400 pl-2">รออนุมัติ</h3>
                    <div id="leave-pending-list" class="space-y-2"></div>
                    <div class="border-t pt-4">
                        <h3 class="font-bold text-gray-700 px-2 text-sm border-l-4 border-gray-300 pl-2">ประวัติย้อนหลัง</h3>
                        <div id="leave-history-list" class="space-y-2 mt-2 opacity-75"></div>
                    </div>
                </div>

                <div id="tab-search" class="tab-content hidden w-full">
                    <div class="bg-white p-3 rounded-xl shadow-sm border border-gray-200 sticky top-0 z-20">
                        <div class="relative">
                            <i class="fa-solid fa-search absolute left-3 top-3 text-gray-400 text-xs"></i>
                            <input type="text" id="search-input" placeholder="ค้นหาชื่อ หรือ รหัสนักศึกษา..." class="w-full pl-9 pr-3 py-2.5 border border-gray-100 bg-gray-50 rounded-lg text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500" oninput="teacherApp.searchStudent()">
                        </div>
                    </div>
                    <div id="search-results" class="space-y-2 mt-4 pb-10"></div>
                </div>

                <div id="tab-settings" class="tab-content hidden w-full space-y-4">
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <h3 class="text-sm font-bold text-gray-800 mb-3 flex items-center gap-2"><i class="fa-solid fa-map-location-dot text-indigo-500"></i> พื้นที่เช็คชื่อ</h3>
                        <div id="map-teacher" class="mb-3 border rounded-lg h-48 bg-gray-100"></div>
                        <div class="flex gap-2">
                             <button onclick="mapSystem.locateTeacher()" class="bg-white border border-gray-200 text-gray-600 px-3 py-2 rounded-lg text-xs font-bold flex-1"><i class="fa-solid fa-crosshairs"></i> พิกัดฉัน</button>
                             <button onclick="teacherApp.saveMapZone()" class="bg-indigo-600 text-white px-3 py-2 rounded-lg text-xs font-bold flex-[2]">บันทึกพื้นที่</button>
                        </div>
                    </div>

                    <!-- Logo Settings Block -->
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 text-center">
                        <h3 class="text-sm font-bold text-gray-800 mb-3">ปรับแต่งหน้าตา</h3>
                        <div class="mb-4">
                            <label class="block text-gray-500 text-xs font-medium mb-2">รูปโลโก้หน้าแรก</label>
                            <div class="relative w-24 h-24 mx-auto mb-2 bg-gray-50 rounded-full border-2 border-white shadow-md overflow-hidden flex items-center justify-center cursor-pointer hover:opacity-90 transition" onclick="document.getElementById('teacher-logo-upload').click()">
                                <img id="setting-logo-preview" 
                                     src="https://upload.wikimedia.org/wikipedia/commons/thumb/c/cb/Seal_of_the_Institute_of_Community_Colleges_of_Thailand.svg/480px-Seal_of_the_Institute_of_Community_Colleges_of_Thailand.svg.png" 
                                     class="w-full h-full object-contain p-2">
                                <div class="absolute inset-0 bg-black/30 flex items-center justify-center opacity-0 hover:opacity-100 transition">
                                    <i class="fa-solid fa-camera text-white text-lg"></i>
                                </div>
                            </div>
                            <input type="file" id="teacher-logo-upload" class="hidden" accept="image/*" onchange="teacherApp.saveLogo(this)">
                            <button onclick="document.getElementById('teacher-logo-upload').click()" class="bg-purple-100 text-purple-600 px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-purple-200 transition">อัปโหลดรูป</button>
                        </div>
                        <button onclick="teacherApp.resetLogo()" class="text-red-400 hover:text-red-600 text-xs underline">รีเซ็ตเป็นค่าเริ่มต้น</button>
                    </div>

                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <h3 class="text-sm font-bold text-gray-800 mb-3"><i class="fa-regular fa-clock text-indigo-500"></i> เวลาเข้าเรียน</h3>
                        <div class="flex gap-2 items-center">
                            <input type="time" id="set-late-time" class="border p-2 rounded-lg text-sm flex-1">
                            <button onclick="teacherApp.saveTimeSettings()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-xs font-bold">บันทึก</button>
                            <button onclick="teacherApp.clearTimeSettings()" class="bg-gray-200 text-gray-600 px-3 py-2 rounded-lg text-xs font-bold">ปิด</button>
                        </div>
                    </div>

                     <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <h3 class="text-sm font-bold text-gray-800 mb-3"><i class="fa-brands fa-google-drive text-green-500"></i> Google Sheets</h3>
                        <input type="url" id="set-sheet-url" class="w-full border p-2 rounded-lg text-xs mb-2" placeholder="วางลิงก์ Google Sheet ที่นี่">
                        
                        <div class="mb-2 pt-2 border-t border-dashed">
                             <div class="flex justify-between items-center mb-1 cursor-pointer" onclick="document.getElementById('adv-webhook').classList.toggle('hidden')">
                                <label class="text-gray-500 text-[10px] font-bold">⚙️ API Webhook</label>
                                <i class="fa-solid fa-chevron-down text-gray-400 text-[10px]"></i>
                            </div>
                            <div id="adv-webhook" class="hidden">
                                <input type="url" id="set-webhook-url" class="w-full border border-gray-200 bg-gray-50 p-2 rounded-lg text-xs" placeholder="GAS Web App URL">
                            </div>
                        </div>

                        <button onclick="teacherApp.saveSheetSettings()" class="w-full bg-green-600 text-white py-2 rounded-lg text-xs font-bold">บันทึกลิงก์</button>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100"><h3 class="text-sm font-bold text-gray-800 mb-3"><i class="fa-solid fa-user-shield text-indigo-500"></i> บัญชีผู้ใช้</h3><div class="space-y-2"><input type="text" id="set-new-user" class="w-full border p-2 rounded-lg text-xs" placeholder="เปลี่ยนชื่อผู้ใช้"><input type="password" id="set-cur-pass" class="w-full border p-2 rounded-lg text-xs" placeholder="รหัสผ่านปัจจุบัน (ยืนยัน)"><div class="grid grid-cols-2 gap-2"><input type="password" id="set-new-pass" class="w-full border p-2 rounded-lg text-xs" placeholder="รหัสผ่านใหม่"><input type="password" id="set-confirm-pass" class="w-full border p-2 rounded-lg text-xs" placeholder="ยืนยันรหัสใหม่"></div><button onclick="teacherApp.saveAccountSettings()" class="w-full bg-indigo-600 text-white py-2 rounded-lg text-xs font-bold mt-2">บันทึกการเปลี่ยนแปลง</button></div></div>
                </div>

                <div class="mobile-bottom-nav justify-around items-center h-16 border-t border-gray-200 bg-white/95 backdrop-blur-md">
                    <button onclick="teacherApp.switchTab('overview')" class="tab-btn-mobile flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-indigo-600 active:text-indigo-600" data-tab="overview"><i class="fa-solid fa-chart-pie text-lg mb-1"></i><span class="text-[10px]">ภาพรวม</span></button>
                    <button onclick="teacherApp.switchTab('students')" class="tab-btn-mobile flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-indigo-600" data-tab="students"><i class="fa-solid fa-users text-lg mb-1"></i><span class="text-[10px]">นศ.</span></button>
                    <button onclick="teacherApp.switchTab('leaves')" class="tab-btn-mobile flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-indigo-600 relative" data-tab="leaves"><div class="relative"><i class="fa-solid fa-envelope-open-text text-lg mb-1"></i><span id="badge-leave-mobile" class="hidden absolute -top-1 -right-2 w-2 h-2 bg-red-500 rounded-full"></span></div><span class="text-[10px]">คำร้อง</span></button>
                    <button onclick="teacherApp.switchTab('settings')" class="tab-btn-mobile flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-indigo-600" data-tab="settings"><i class="fa-solid fa-gear text-lg mb-1"></i><span class="text-[10px]">ตั้งค่า</span></button>
                </div>
            </div>

            <!-- Details Page -->
            <!-- FIX: Added 'flex' class so 'hidden' removal works correctly and added Graphs/Filters -->
            <div id="page-student-details" class="hidden flex-col w-full h-full bg-white absolute inset-0 z-40 overflow-y-auto">
                <div class="bg-white shadow-sm p-4 flex items-center gap-3 sticky top-0 z-10"><button onclick="teacherApp.closeStudentDetails()" class="p-2 rounded-full bg-gray-100 text-gray-600"><i class="fa-solid fa-arrow-left"></i></button><h2 class="text-lg font-bold text-gray-800">ข้อมูลนักศึกษา</h2></div>
                <div class="p-4 space-y-4 pb-20">
                     <div class="bg-indigo-50 p-4 rounded-xl text-center"><div class="w-16 h-16 bg-white text-indigo-600 rounded-full flex items-center justify-center mx-auto mb-2 text-2xl shadow-sm font-bold" id="sd-avatar">A</div><h2 id="sd-name" class="text-lg font-bold text-indigo-900">...</h2><p id="sd-id" class="text-sm text-indigo-600">...</p><p id="sd-major" class="text-xs text-indigo-400 mt-1">...</p></div>
                     
                     <!-- FIX: Added Filter & Charts to Student Details -->
                     <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col sm:flex-row gap-3 items-center justify-between">
                         <div class="flex items-center gap-2"><i class="fa-solid fa-filter text-purple-500"></i><h3 class="font-bold text-gray-700 text-sm">ตัวกรอง</h3></div>
                         <div class="flex gap-2 w-full sm:w-auto">
                             <select id="sd-filter-type" onchange="teacherApp.toggleSdFilterType()" class="border p-2 rounded-lg text-xs bg-gray-50"><option value="monthly">รายเดือน</option><option value="yearly">รายปี</option></select>
                             <input type="month" id="sd-filter-month" class="border p-2 rounded-lg text-xs flex-1" onchange="teacherApp.loadStudentDetails()">
                             <input type="number" id="sd-filter-year" class="border p-2 rounded-lg text-xs flex-1 hidden" placeholder="ปี ค.ศ." onchange="teacherApp.loadStudentDetails()">
                         </div>
                     </div>

                     <div class="grid grid-cols-4 gap-2 text-center">
                         <div class="bg-green-50 p-2 rounded-lg border border-green-100"><div class="text-green-700 font-bold text-lg" id="sd-stat-present">0</div><div class="text-[10px] text-green-600">มา</div></div>
                         <div class="bg-yellow-50 p-2 rounded-lg border border-yellow-100"><div class="text-yellow-700 font-bold text-lg" id="sd-stat-late">0</div><div class="text-[10px] text-yellow-600">สาย</div></div>
                         <div class="bg-orange-50 p-2 rounded-lg border border-orange-100"><div class="text-orange-700 font-bold text-lg" id="sd-stat-leave">0</div><div class="text-[10px] text-orange-600">ลา</div></div>
                         <div class="bg-red-50 p-2 rounded-lg border border-red-100"><div class="text-red-700 font-bold text-lg" id="sd-stat-absent">0</div><div class="text-[10px] text-red-600">ขาด</div></div>
                     </div>

                     <!-- Detail Charts -->
                     <div class="grid md:grid-cols-2 gap-4">
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                            <h3 class="text-xs font-bold text-gray-500 mb-2">แนวโน้ม</h3>
                            <div class="h-32 relative"><canvas id="sdChartLine"></canvas></div>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                            <h3 class="text-xs font-bold text-gray-500 mb-2">สัดส่วน</h3>
                            <div class="h-32 relative flex justify-center"><canvas id="sdChartPie"></canvas></div>
                        </div>
                     </div>

                     <div class="bg-white border rounded-xl overflow-hidden">
                         <div class="p-3 bg-gray-50 text-xs font-bold border-b text-gray-500">ประวัติการลงเวลา</div>
                         <table class="w-full text-xs"><tbody id="sd-history-body" class="divide-y divide-gray-50"></tbody></table>
                     </div>
                     <div class="flex gap-2">
                        <button onclick="teacherApp.toggleLock(teacherApp.currentViewingStudentId)" class="flex-1 bg-gray-100 text-gray-600 py-3 rounded-xl font-bold text-sm hover:bg-gray-200">
                             <i class="fa-solid fa-lock"></i> ล็อค/ปลดล็อค
                        </button>
                        <button onclick="teacherApp.deleteStudent(teacherApp.currentViewingStudentId)" class="flex-1 bg-red-50 text-red-600 py-3 rounded-xl font-bold text-sm hover:bg-red-100">
                             <i class="fa-solid fa-trash"></i> ลบข้อมูล
                        </button>
                     </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Modals -->
    <div id="modal-leave" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4 transition-all">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl animate-fade-in">
            <h3 class="text-xl font-bold mb-4 flex items-center gap-2"><i class="fa-solid fa-pen-to-square text-orange-500"></i> ยื่นคำร้องลาเรียน</h3>
            <div class="mb-4"><label class="block text-sm font-bold mb-1">วันที่ลา</label><input type="date" id="leave-date" class="w-full border p-2.5 rounded-lg"></div>
            <div class="mb-4"><label class="block text-sm font-bold mb-1">เหตุผล</label><textarea id="leave-reason" rows="3" class="w-full border p-2.5 rounded-lg"></textarea></div>
            <div class="flex gap-2"><button onclick="document.getElementById('modal-leave').classList.add('hidden')" class="flex-1 bg-gray-100 py-2.5 rounded-lg font-bold text-gray-600">ยกเลิก</button><button onclick="studentApp.submitLeave()" class="flex-1 bg-orange-500 text-white py-2.5 rounded-lg font-bold hover:bg-orange-600">ส่งคำร้อง</button></div>
        </div>
    </div>

    <script>
        const CONFIG = { COLLEGE_LAT: 6.826222, COLLEGE_LNG: 100.966639, ADMIN: { user: 'chod', pass: 'az12312121' }, DEFAULT_LOGO: 'https://upload.wikimedia.org/wikipedia/commons/thumb/c/cb/Seal_of_the_Institute_of_Community_Colleges_of_Thailand.svg/480px-Seal_of_the_Institute_of_Community_Colleges_of_Thailand.svg.png' };
        const DB = {
            KEY: 'tcc_gps_v3_full_final',
            getAll() { const d=localStorage.getItem(this.KEY); return d?JSON.parse(d):[]; },
            save(d) { localStorage.setItem(this.KEY, JSON.stringify(d)); },
            addRecord(r) { const d=this.getAll(); d.push(r); this.save(d); return r; },
            updateRecord(fn,up) { const d=this.getAll(); const i=d.findIndex(fn); if(i!==-1){d[i]=up(d[i]); this.save(d); return true;} return false; },
            getStudents() { return this.getAll().filter(r=>r.type==='registration'); },
            getAttendance() { return this.getAll().filter(r=>r.type==='attendance'); },
            getLeaves() { return this.getAll().filter(r=>r.type==='leave'); },
            getZone() { return JSON.parse(localStorage.getItem('tcc_map_zone')); },
            saveZone(g) { localStorage.setItem('tcc_map_zone', JSON.stringify(g)); }
        };
        const DEVICE_ID = localStorage.getItem('device_fingerprint') || (() => { const id='fp_'+Math.random().toString(36).substr(2,9); localStorage.setItem('device_fingerprint',id); return id; })();

        // SEED DUMMY DATA FOR DEMO
        const seedData = () => {
             const students = DB.getStudents();
             if(students.length === 0) {
                 const demoStudents = [
                     { student_id: '660001', student_name: 'สมชาย ใจดี', major: 'คอมพิวเตอร์', type: 'registration', is_locked: false },
                     { student_id: '660002', student_name: 'สมหญิง รักเรียน', major: 'การบัญชี', type: 'registration', is_locked: false },
                     { student_id: '660003', student_name: 'มานะ ขยัน', major: 'คอมพิวเตอร์', type: 'registration', is_locked: false }
                 ];
                 const d = new Date().toISOString();
                 const demoAtt = [
                     { type: 'attendance', student_id: '660001', student_name: 'สมชาย ใจดี', major: 'คอมพิวเตอร์', check_in_time: d, check_in_status: 'on_time' },
                     { type: 'attendance', student_id: '660002', student_name: 'สมหญิง รักเรียน', major: 'การบัญชี', check_in_time: d, check_in_status: 'late' }
                 ];
                 const allData = [...demoStudents, ...demoAtt];
                 DB.save(allData);
             }
        };

        const mapSystem = {
            teacherMap: null, drawnItems: null, teacherMarker: null,
            initTeacherMap() {
                if (this.teacherMap) return;
                setTimeout(() => {
                    this.teacherMap = L.map('map-teacher', { zoomControl: false }).setView([CONFIG.COLLEGE_LAT, CONFIG.COLLEGE_LNG], 17);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(this.teacherMap);
                    this.drawnItems = new L.FeatureGroup().addTo(this.teacherMap);
                    const savedZone = DB.getZone();
                    if(savedZone) L.geoJSON(savedZone, { onEachFeature: (f, l) => { this.drawnItems.addLayer(l); } });
                    const drawControl = new L.Control.Draw({ draw: { polygon: true, marker: false, circle: false, circlemarker: false, polyline: false, rectangle: true }, edit: { featureGroup: this.drawnItems } });
                    this.teacherMap.addControl(drawControl);
                    this.teacherMap.on(L.Draw.Event.CREATED, (e) => { this.drawnItems.clearLayers(); this.drawnItems.addLayer(e.layer); });
                    this.locateTeacher();
                }, 500);
            },
            locateTeacher() {
                if(!navigator.geolocation) return;
                navigator.geolocation.getCurrentPosition(pos => {
                    const { latitude, longitude } = pos.coords;
                    if(this.teacherMarker) this.teacherMap.removeLayer(this.teacherMarker);
                    this.teacherMarker = L.circleMarker([latitude, longitude], { radius: 8, color: 'blue', fillColor: '#3b82f6', fillOpacity: 0.8 }).addTo(this.teacherMap).bindPopup('คุณ').openPopup();
                    this.teacherMap.setView([latitude, longitude], 18);
                }, e => console.warn(e));
            },
            checkInZone(lat, lng) {
                const savedZone = DB.getZone();
                if (!savedZone) {
                    const R = 6371e3; const φ1 = lat * Math.PI/180; const φ2 = CONFIG.COLLEGE_LAT * Math.PI/180;
                    const a = Math.sin((CONFIG.COLLEGE_LAT-lat)*Math.PI/180/2)**2 + Math.cos(φ1) * Math.cos(φ2) * Math.sin((CONFIG.COLLEGE_LNG-lng)*Math.PI/180/2)**2;
                    return (R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a))) <= 50; 
                }
                const pt = turf.point([lng, lat]); 
                const features = savedZone.type === 'FeatureCollection' ? savedZone.features : [savedZone];
                let isInside = false;
                features.forEach(f => { if (turf.booleanPointInPolygon(pt, f)) isInside = true; });
                return isInside;
            }
        };

        const gpsSystem = {
            watchId: null, currentLat: null, currentLng: null, isDemoMode: false,
            toggleDemoMode() {
                this.isDemoMode = !this.isDemoMode;
                Swal.fire({ icon: 'info', title: this.isDemoMode?'Demo Mode: ON':'OFF', timer: 1000, showConfirmButton:false });
                if(router.currentPage === 'student-dashboard') this.startTracking();
            },
            startTracking() {
                if(this.isDemoMode) { this.updateUI(CONFIG.COLLEGE_LAT + 0.0001, CONFIG.COLLEGE_LNG + 0.0001, 5); return; }
                if(!navigator.geolocation) return;
                this.watchId = navigator.geolocation.watchPosition(
                    (p) => this.updateUI(p.coords.latitude, p.coords.longitude, p.coords.accuracy),
                    (e) => { console.warn(e); document.getElementById('st-status-text').innerText = "GPS Error"; },
                    { enableHighAccuracy: true }
                );
            },
            stopTracking() { if(this.watchId) navigator.geolocation.clearWatch(this.watchId); },
            updateUI(lat, lng, acc) {
                this.currentLat = lat; this.currentLng = lng;
                const inZone = mapSystem.checkInZone(lat, lng);
                const btn = document.getElementById('btn-checkin');
                const statusTxt = document.getElementById('st-status-text');
                const distEl = document.getElementById('st-dist');
                const accEl = document.getElementById('st-acc');
                
                const R = 6371e3; const a = Math.sin((CONFIG.COLLEGE_LAT-lat)*Math.PI/180/2)**2 + Math.cos(lat*Math.PI/180) * Math.cos(CONFIG.COLLEGE_LAT*Math.PI/180) * Math.sin((CONFIG.COLLEGE_LNG-lng)*Math.PI/180/2)**2;
                const dist = R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

                if (distEl) distEl.innerText = dist > 1000 ? (dist/1000).toFixed(2) + " กม." : dist.toFixed(0) + " ม.";
                if (accEl) accEl.innerText = `±${acc.toFixed(0)} ม.`;

                if(inZone) {
                    if (statusTxt) { statusTxt.innerHTML = "อยู่ในพื้นที่ ✅"; statusTxt.className = "font-bold text-green-600 text-xs mt-1"; }
                    if (btn) { btn.className = "w-full py-6 rounded-2xl bg-gradient-brand text-white font-bold text-xl shadow-lg transition-all transform active:scale-95"; btn.innerHTML = `<div class="flex flex-col items-center"><i class="fa-solid fa-location-dot animate-bounce text-4xl mb-2"></i><span>กดเช็คชื่อเข้าเรียน</span></div>`; btn.disabled = false; btn.onclick = () => studentApp.checkIn(); }
                } else {
                    if (statusTxt) { statusTxt.innerHTML = "อยู่นอกพื้นที่ ❌"; statusTxt.className = "font-bold text-red-500 text-xs mt-1"; }
                    if (btn) { btn.className = "w-full py-6 rounded-2xl bg-gray-200 text-gray-400 font-bold text-xl shadow-inner cursor-not-allowed"; btn.innerHTML = `<div class="flex flex-col items-center"><i class="fa-solid fa-ban text-4xl mb-2 opacity-50"></i><span>ต้องอยู่ในพื้นที่</span></div>`; btn.disabled = true; }
                }
            }
        };

        const router = {
            currentPage: null,
            navigateTo(pageId) {
                this.currentPage = pageId;
                document.querySelectorAll('[id^="page-"]').forEach(el => {
                    el.classList.add('force-hide'); el.classList.remove('force-show');
                    if(el.id !== `page-${pageId}`) {
                        el.style.display = 'none';
                        el.classList.add('hidden');
                    }
                });

                const target = document.getElementById(`page-${pageId}`);
                if (target) {
                    target.classList.remove('force-hide', 'hidden');
                    target.classList.add('force-show', 'animate-fade-in');
                    if(['page-student-register','page-teacher-login','page-student-details','page-teacher-dashboard'].includes(target.id)) {
                        target.style.display = 'flex';
                    } else {
                         target.style.display = 'block';
                    }
                }
                
                if (pageId === 'student-dashboard') studentApp.initDashboard(); else gpsSystem.stopTracking();
                if (pageId === 'teacher-dashboard') teacherApp.initDashboard();
                if (pageId === 'student-auth') { if (studentApp.isRegistered()) this.navigateTo('student-dashboard'); else this.navigateTo('student-register'); }
            }
        };

        const studentApp = {
            currentUser: null,
            isRegistered() {
                try {
                    const u = JSON.parse(localStorage.getItem('current_student_user'));
                    if(u && DB.getStudents().find(s=>s.student_id===u.student_id)) { this.currentUser=u; return true; }
                } catch(e){} return false;
            },
            register(e) {
                e.preventDefault();
                Swal.fire({ title: 'กำลังบันทึก...', didOpen: () => Swal.showLoading() });
                setTimeout(() => {
                    try {
                        const id = document.getElementById('reg-id').value.trim();
                        const name = document.getElementById('reg-name').value.trim();
                        const major = document.getElementById('reg-major').value.trim();
                        if(!id || !name || !major) throw new Error("ข้อมูลไม่ครบ");
                        if(DB.getStudents().find(s=>s.student_id===id)) throw new Error("รหัสนี้มีอยู่แล้ว");

                        const u = { student_id: id, student_name: name, major: major, type: 'registration', is_locked: false, registered_at: new Date().toISOString() };
                        DB.addRecord(u);
                        localStorage.setItem('current_student_user', JSON.stringify(u));
                        this.currentUser = u;
                        Swal.fire({ icon: 'success', title: 'ลงทะเบียนสำเร็จ', timer: 1000, showConfirmButton: false }).then(() => { router.navigateTo('student-dashboard'); });
                    } catch(err) { Swal.fire('เกิดข้อผิดพลาด', err.message, 'error'); }
                }, 500);
            },
            initDashboard() {
                if(!this.currentUser && !this.isRegistered()) { router.navigateTo('landing'); return; }
                document.getElementById('st-dash-name').innerText = this.currentUser.student_name;
                document.getElementById('st-dash-id').innerText = this.currentUser.student_id;
                const btn = document.getElementById('btn-reset-account');
                if(this.currentUser.is_locked) { btn.innerHTML = '<div class="text-red-500 font-bold">ถูกล็อค</div>'; btn.disabled=true; }
                else { btn.disabled=false; }
                gpsSystem.startTracking();
                this.updateStats();
            },
            checkIn() {
                // FIX: Check GPS & Zone
                if (gpsSystem.currentLat === null || gpsSystem.currentLng === null) { Swal.fire('รอสักครู่', 'กำลังค้นหา GPS', 'warning'); return; }
                const inZone = mapSystem.checkInZone(gpsSystem.currentLat, gpsSystem.currentLng);
                if (!inZone && !gpsSystem.isDemoMode) { Swal.fire('ผิดพลาด', 'อยู่นอกพื้นที่', 'error'); return; }

                const today = new Date().toISOString().split('T')[0];
                const att = DB.getAttendance();
                if(att.find(a => a.student_id === this.currentUser.student_id && a.check_in_time.startsWith(today))) { Swal.fire('แจ้งเตือน', 'วันนี้เช็คชื่อไปแล้ว', 'info'); return; }
                
                const now = new Date();
                let status = 'on_time';
                const lateStr = localStorage.getItem('tcc_late_threshold');
                if(lateStr) { const [h, m] = lateStr.split(':'); const th = new Date(); th.setHours(h, m, 0, 0); if(now > th) status = 'late'; }
                const rec = { type: 'attendance', student_id: this.currentUser.student_id, student_name: this.currentUser.student_name, major: this.currentUser.major, check_in_time: now.toISOString(), check_in_status: status, latitude: gpsSystem.currentLat, longitude: gpsSystem.currentLng, device_fingerprint: DEVICE_ID };
                DB.addRecord(rec);
                this.updateStats();
                const hook = localStorage.getItem('tcc_webhook_url');
                if(hook) fetch(hook, { method: 'POST', mode: 'no-cors', headers: {'Content-Type':'application/json'}, body: JSON.stringify(rec) });
                Swal.fire({ icon: status==='late'?'warning':'success', title: 'เช็คชื่อสำเร็จ'+(status==='late'?' (สาย)':''), timer: 2000, showConfirmButton:false });
            },
            openLeaveModal() { document.getElementById('modal-leave').classList.remove('hidden'); },
            submitLeave() {
                const d = document.getElementById('leave-date').value;
                const r = document.getElementById('leave-reason').value;
                if(!d || !r) return;
                DB.addRecord({ type: 'leave', student_id: this.currentUser.student_id, student_name: this.currentUser.student_name, date: d, leave_reason: r, leave_status: 'pending', requested_at: new Date().toISOString() });
                document.getElementById('modal-leave').classList.add('hidden');
                Swal.fire('ส่งคำร้องแล้ว', '', 'success');
                this.updateStats(); 
            },
            resetAccount() { Swal.fire({ title: 'ลบบัญชี?', showCancelButton: true, confirmButtonText: 'ลบ' }).then((r) => { if(r.isConfirmed) { localStorage.removeItem('current_student_user'); router.navigateTo('landing'); } }); },
            updateStats() {
                const att = DB.getAttendance().filter(a => a.student_id === this.currentUser.student_id);
                const leaves = DB.getLeaves().filter(l => l.student_id === this.currentUser.student_id && l.leave_status === 'approved');
                const allAtt = DB.getAttendance();
                const uniqueDays = [...new Set(allAtt.map(a => a.check_in_time ? a.check_in_time.split('T')[0] : ''))].filter(d => d);
                const p = att.filter(a=>a.check_in_status!=='late').length;
                const l = att.filter(a=>a.check_in_status==='late').length;
                const le = leaves.length;
                let ab = 0;
                uniqueDays.forEach(day => {
                    const isPresent = att.some(a => a.check_in_time.startsWith(day));
                    const isApprovedLeave = leaves.some(l => l.date === day);
                    if (!isPresent && !isApprovedLeave) ab++;
                });

                document.getElementById('stat-present').innerText = p;
                document.getElementById('stat-late').innerText = l;
                document.getElementById('stat-leave').innerText = le;
                document.getElementById('stat-absent').innerText = ab;
                document.getElementById('stat-chart-total').innerText = uniqueDays.length || 0;

                const ctx = document.getElementById('studentStatChart')?.getContext('2d');
                if (ctx) {
                    if (window.studentChart) window.studentChart.destroy();
                    const total = p + l + le + ab;
                    const data = total === 0 ? [1] : [p, l, le, ab];
                    const colors = total === 0 ? ['#f3f4f6'] : ['#4ade80', '#facc15', '#fb923c', '#f87171'];
                    window.studentChart = new Chart(ctx, {
                        type: 'doughnut',
                        data: { labels: ['ทันเวลา', 'สาย', 'ลา', 'ขาด'], datasets: [{ data: data, backgroundColor: colors, borderWidth: 0, hoverOffset: 4 }] },
                        options: { responsive: true, maintainAspectRatio: false, cutout: '75%', plugins: { legend: { display: false }, tooltip: { enabled: total !== 0 } } }
                    });
                }
            }
        };

        const teacherApp = {
            currentViewingStudentId: null,
            login(e) { e.preventDefault(); const u = document.getElementById('t-user').value; const p = document.getElementById('t-pass').value; const admin = JSON.parse(localStorage.getItem('tcc_admin_creds')) || CONFIG.ADMIN; if(u===admin.user && p===admin.pass) router.navigateTo('teacher-dashboard'); else Swal.fire('ผิดพลาด', '', 'error'); },
            logout() { document.getElementById('t-user').value=''; document.getElementById('t-pass').value=''; router.navigateTo('landing'); },
            initDashboard() { 
                const t = new Date(); 
                const dateStr = t.toISOString().split('T')[0];
                const monthStr = dateStr.substring(0, 7);
                const yearStr = t.getFullYear();
                const elDate = document.getElementById('filter-date'); if(elDate) elDate.value = dateStr;
                const elMonth = document.getElementById('filter-month'); if(elMonth) elMonth.value = monthStr;
                const elYear = document.getElementById('filter-year'); if(elYear) elYear.value = yearStr;
                this.switchTab('overview');
                this.updateBadge();
            },
            switchTab(name) {
                document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                document.getElementById('tab-'+name).classList.remove('hidden');
                document.querySelectorAll('.tab-btn, .tab-btn-mobile').forEach(b => {
                     const isActive = b.dataset.tab === name;
                     if(b.classList.contains('tab-btn')) { isActive ? b.classList.add('bg-white','text-brand','shadow-sm') : b.classList.remove('bg-white','text-brand','shadow-sm'); }
                     else { isActive ? b.classList.add('text-indigo-600') : b.classList.remove('text-indigo-600'); b.classList.toggle('text-gray-400', !isActive); }
                });
                if(name === 'settings') { this.loadSettings(); setTimeout(() => mapSystem.initTeacherMap(), 200); }
                if(name === 'overview') this.loadOverview();
                if(name === 'students') this.loadStudents();
                if(name === 'leaves') this.loadLeaves();
            },
            loadSettings() { document.getElementById('set-late-time').value = localStorage.getItem('tcc_late_threshold') || ''; document.getElementById('set-sheet-url').value = localStorage.getItem('tcc_sheet_url') || ''; },
            saveMapZone() { if(!mapSystem.drawnItems) return; const layers = mapSystem.drawnItems.getLayers(); if(layers.length === 0) { localStorage.removeItem('tcc_map_zone'); Swal.fire('ลบพื้นที่แล้ว', 'กลับไปใช้ระบบระยะทางปกติ (50m)', 'info'); return; } const geoJSON = layers[0].toGeoJSON(); DB.saveZone(geoJSON); Swal.fire('สำเร็จ', 'บันทึกขอบเขตแล้ว', 'success'); },
            
            loadOverview() { 
                const att = DB.getAttendance(); const students = DB.getStudents(); const leaves = DB.getLeaves();
                const filterMajorEl = document.getElementById('overview-filter-major');
                if (filterMajorEl.options.length <= 1) {
                    const uniqueMajors = [...new Set(students.map(s => s.major))].sort();
                    uniqueMajors.forEach(m => { if(m) { const opt = document.createElement('option'); opt.value = m; opt.innerText = m; filterMajorEl.appendChild(opt); } });
                }
                const selectedMajor = filterMajorEl.value;
                const filteredStudents = selectedMajor === 'all' ? students : students.filter(s => s.major === selectedMajor);
                const filteredAttendance = selectedMajor === 'all' ? att : att.filter(a => { const s = students.find(st => st.student_id === a.student_id); return s && s.major === selectedMajor; });
                const filteredLeaves = selectedMajor === 'all' ? leaves : leaves.filter(l => { const s = students.find(st => st.student_id === l.student_id); return s && s.major === selectedMajor; });

                const date = document.getElementById('filter-date').value;
                const todayCount = filteredAttendance.filter(a => a.check_in_time.startsWith(date)).length;
                const lateCount = filteredAttendance.filter(a => a.check_in_time.startsWith(date) && a.check_in_status === 'late').length;
                
                document.getElementById('overview-today-count').innerText = todayCount; 
                document.getElementById('overview-total-count').innerText = filteredStudents.length;

                const ctx = document.getElementById('attendanceChart')?.getContext('2d');
                if (ctx) {
                   if (window.myChart) window.myChart.destroy();
                   window.myChart = new Chart(ctx, { type: 'bar', data: { labels: ['มาทัน', 'มาสาย'], datasets: [{ label: 'จำนวน', data: [todayCount-lateCount, lateCount], backgroundColor: ['#4ade80', '#facc15'], borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false } });
                }

                const ctxPie = document.getElementById('overviewPieChart')?.getContext('2d');
                if (ctxPie) {
                    if (window.myPieChart) window.myPieChart.destroy();
                    const leavesCount = filteredLeaves.filter(l => l.date === date && l.leave_status === 'approved').length;
                    const absentCount = Math.max(0, filteredStudents.length - todayCount - leavesCount);
                    const onTimeCount = todayCount - lateCount;
                    const data = (filteredStudents.length === 0) ? [1] : [onTimeCount, lateCount, leavesCount, absentCount];
                    const colors = (filteredStudents.length === 0) ? ['#eee'] : ['#4ade80', '#facc15', '#fb923c', '#f87171'];
                    const labels = (filteredStudents.length === 0) ? ['ไม่มีข้อมูล'] : ['ทันเวลา', 'สาย', 'ลา', 'ขาด'];
                    window.myPieChart = new Chart(ctxPie, { type: 'doughnut', data: { labels: labels, datasets: [{ data: data, backgroundColor: colors, borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'right', labels: { boxWidth: 10 } } } } });
                }
            },
            
            loadStudents() {
                const tb = document.getElementById('student-list-body'); 
                tb.innerHTML = '';
                
                const filterMajor = document.getElementById('student-filter-major');
                const filterMonth = document.getElementById('student-filter-month');
                
                if(!filterMonth.value) filterMonth.value = new Date().toISOString().substring(0, 7);
                const selectedMonth = filterMonth.value;

                const students = DB.getStudents();
                const attendance = DB.getAttendance();
                const leaves = DB.getLeaves();

                if (filterMajor.options.length <= 1) {
                    [...new Set(students.map(s => s.major))].sort().forEach(m => { 
                        if(m) { const opt = document.createElement('option'); opt.value = m; opt.innerText = m; filterMajor.appendChild(opt); } 
                    });
                }
                
                const selectedMajor = filterMajor.value;
                const list = selectedMajor === 'all' ? students : students.filter(s => s.major === selectedMajor);
                
                if (list.length === 0) { 
                    tb.innerHTML = '<tr><td colspan="3" class="text-center py-8 text-gray-400 text-xs">ไม่พบข้อมูลนักศึกษา</td></tr>'; 
                    return; 
                }

                list.forEach(s => {
                    const sAtt = attendance.filter(a => a.student_id === s.student_id && a.check_in_time.startsWith(selectedMonth));
                    const sLeaves = leaves.filter(l => l.student_id === s.student_id && l.leave_status === 'approved' && l.date.startsWith(selectedMonth));
                    
                    const present = sAtt.filter(a => a.check_in_status !== 'late').length;
                    const late = sAtt.filter(a => a.check_in_status === 'late').length;
                    const leave = sLeaves.length;
                    
                    const lockIconClass = s.is_locked ? 'text-red-500 bg-red-50 border-red-100' : 'text-gray-400 hover:text-gray-600 bg-white border-gray-200';
                    const lockIcon = s.is_locked ? 'fa-lock' : 'fa-lock-open';

                    const row = document.createElement('tr'); 
                    row.className = "hover:bg-indigo-50/30 transition group border-b border-gray-50";
                    row.innerHTML = `<td class="px-4 py-3 cursor-pointer" onclick="teacherApp.loadStudentDetails('${s.student_id}')"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-gradient-brand flex items-center justify-center text-white text-xs font-bold shadow-sm flex-shrink-0">${s.student_name.charAt(0)}</div><div><div class="font-bold text-gray-800 text-sm group-hover:text-indigo-700 transition-colors">${s.student_name}</div><div class="text-[10px] text-gray-400 flex items-center gap-1"><i class="fa-solid fa-id-card"></i> ${s.student_id} </div></div></div></td><td class="px-2 py-3 text-center cursor-pointer" onclick="teacherApp.loadStudentDetails('${s.student_id}')"><div class="flex justify-center gap-2"><div class="text-center w-8"><div class="text-xs font-bold text-green-600 bg-green-50 px-1 py-0.5 rounded-md border border-green-100">${present}</div><div class="text-[9px] text-gray-400 mt-0.5">มา</div></div><div class="text-center w-8"><div class="text-xs font-bold text-yellow-600 bg-yellow-50 px-1 py-0.5 rounded-md border border-yellow-100">${late}</div><div class="text-[9px] text-gray-400 mt-0.5">สาย</div></div><div class="text-center w-8"><div class="text-xs font-bold text-orange-600 bg-orange-50 px-1 py-0.5 rounded-md border border-orange-100">${leave}</div><div class="text-[9px] text-gray-400 mt-0.5">ลา</div></div></div></td><td class="px-4 py-3 text-right"><div class="flex justify-end gap-2"><button onclick="event.stopPropagation(); teacherApp.toggleLock('${s.student_id}')" class="w-7 h-7 rounded-lg border flex items-center justify-center transition-all shadow-sm ${lockIconClass}" title="${s.is_locked ? 'ปลดล็อค' : 'ล็อคบัญชี'}"><i class="fa-solid ${lockIcon} text-[10px]"></i></button><button onclick="event.stopPropagation(); teacherApp.deleteStudent('${s.student_id}')" class="w-7 h-7 rounded-lg border border-gray-200 bg-white text-gray-400 hover:text-red-600 hover:bg-red-50 hover:border-red-100 flex items-center justify-center transition-all shadow-sm" title="ลบข้อมูล"><i class="fa-solid fa-trash-can text-[10px]"></i></button></div></td>`;
                    tb.appendChild(row);
                });
            },
            toggleFilterType() { 
                const type = document.getElementById('filter-type').value;
                document.getElementById('filter-date').classList.toggle('hidden', type !== 'daily');
                document.getElementById('filter-month').classList.toggle('hidden', type !== 'monthly');
                document.getElementById('filter-year').classList.toggle('hidden', type !== 'yearly');
                this.loadOverview(); 
            },
            toggleSdFilterType() { teacherApp.loadStudentDetails(teacherApp.currentViewingStudentId); },
            saveTimeSettings() { localStorage.setItem('tcc_late_threshold', document.getElementById('set-late-time').value); Swal.fire('บันทึกเวลาแล้ว','','success'); },
            clearTimeSettings() { localStorage.removeItem('tcc_late_threshold'); document.getElementById('set-late-time').value=''; Swal.fire('ปิดเวลาสาย','','success'); },
            saveSheetSettings() { localStorage.setItem('tcc_sheet_url', document.getElementById('set-sheet-url').value); Swal.fire('บันทึก','','success'); },
            openSheet() { const u=localStorage.getItem('tcc_sheet_url'); if(u) window.open(u); else Swal.fire('','ใส่ลิงก์ก่อน','warning'); },
            exportToCSV() { 
                const data = DB.getAttendance(); if (!data.length) { Swal.fire('ไม่มีข้อมูล', '', 'warning'); return; }
                let csv = "\uFEFFวันที่,เวลา,รหัส,ชื่อ,สาขา,สถานะ,พิกัด\n";
                data.forEach(r => { const d = new Date(r.check_in_time); csv += `${d.toLocaleDateString()},${d.toLocaleTimeString()},${r.student_id},"${r.student_name}",${r.major},${r.check_in_status},"${r.latitude},${r.longitude}"\n`; });
                const link = document.createElement("a"); link.href = encodeURI("data:text/csv;charset=utf-8," + csv); link.download = "attendance.csv"; document.body.appendChild(link); link.click(); document.body.removeChild(link);
            },
            saveLogo(input) { 
                if (input.files && input.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image(); img.src = e.target.result;
                        img.onload = () => {
                            const cvs = document.createElement('canvas');
                            let w=img.width, h=img.height;
                            if (w>300 || h>300) { if(w>h) { h*=300/w; w=300; } else { w*=300/h; h=300; } }
                            cvs.width=w; cvs.height=h;
                            cvs.getContext('2d').drawImage(img,0,0,w,h);
                            const b64 = cvs.toDataURL('image/jpeg', 0.7);
                            localStorage.setItem('app_custom_logo', b64);
                            document.getElementById('setting-logo-preview').src = b64;
                            document.getElementById('app-logo').src = b64;
                            Swal.fire('สำเร็จ', 'เปลี่ยนโลโก้แล้ว', 'success');
                        };
                    };
                    reader.readAsDataURL(input.files[0]);
                }
            },
            resetLogo() {
                localStorage.removeItem('app_custom_logo');
                document.getElementById('setting-logo-preview').src = CONFIG.DEFAULT_LOGO;
                document.getElementById('app-logo').src = CONFIG.DEFAULT_LOGO;
                Swal.fire('สำเร็จ', 'รีเซ็ตโลโก้แล้ว', 'success');
            },
            saveAccountSettings() {
                const nu = document.getElementById('set-new-user').value.trim();
                const cp = document.getElementById('set-cur-pass').value;
                const np = document.getElementById('set-new-pass').value;
                const cnp = document.getElementById('set-confirm-pass').value;
                const stored = JSON.parse(localStorage.getItem('tcc_admin_creds'));
                const vp = stored ? stored.pass : CONFIG.ADMIN.pass;
                const vu = stored ? stored.user : CONFIG.ADMIN.user;
                if (cp !== vp) { Swal.fire('ผิดพลาด', 'รหัสเดิมผิด', 'error'); return; }
                if (np && np !== cnp) { Swal.fire('ผิดพลาด', 'รหัสใหม่ไม่ตรงกัน', 'error'); return; }
                localStorage.setItem('tcc_admin_creds', JSON.stringify({ user: nu || vu, pass: np || vp }));
                Swal.fire('สำเร็จ', 'บันทึกข้อมูลบัญชีแล้ว', 'success');
            },
            closeStudentDetails() { document.getElementById('page-student-details').classList.add('hidden'); },
            loadStudentDetails(id) {
                this.currentViewingStudentId = id;
                const s = DB.getStudents().find(x => x.student_id === id);
                if(!s) return;
                document.getElementById('page-student-details').classList.remove('hidden');
                document.getElementById('sd-name').innerText = s.student_name;
                document.getElementById('sd-id').innerText = s.student_id;
                document.getElementById('sd-major').innerText = s.major;
                document.getElementById('sd-avatar').innerText = s.student_name.charAt(0);
                
                // Load Filters
                const type = document.getElementById('sd-filter-type').value;
                const m = document.getElementById('sd-filter-month');
                const y = document.getElementById('sd-filter-year');
                
                if (type === 'monthly') {
                     m.classList.remove('hidden'); y.classList.add('hidden');
                     if(!m.value) m.value = new Date().toISOString().substring(0, 7);
                } else {
                     m.classList.add('hidden'); y.classList.remove('hidden');
                     if(!y.value) y.value = new Date().getFullYear();
                }

                // Load Stats & Charts
                const att = DB.getAttendance().filter(a => a.student_id === id);
                const leaves = DB.getLeaves().filter(l => l.student_id === id && l.leave_status === 'approved');
                
                let filteredAtt = [], filteredLeaves = [];
                if (type === 'monthly') {
                    filteredAtt = att.filter(a => a.check_in_time.startsWith(m.value));
                    filteredLeaves = leaves.filter(l => l.date.startsWith(m.value));
                } else {
                    filteredAtt = att.filter(a => a.check_in_time.startsWith(y.value));
                    filteredLeaves = leaves.filter(l => l.date.startsWith(y.value));
                }

                const p = filteredAtt.filter(a=>a.check_in_status!=='late').length;
                const late = filteredAtt.filter(a=>a.check_in_status==='late').length;
                const l = filteredLeaves.length;
                
                // Absent Logic
                const allAtt = DB.getAttendance();
                const uniqueDays = [...new Set(allAtt.map(a => a.check_in_time ? a.check_in_time.split('T')[0] : ''))].filter(d => {
                     return (type === 'monthly') ? d.startsWith(m.value) : d.startsWith(y.value);
                });
                let ab = 0;
                uniqueDays.forEach(day => {
                    const isPresent = filteredAtt.some(a => a.check_in_time.startsWith(day));
                    const isApprovedLeave = filteredLeaves.some(l => l.date === day);
                    if (!isPresent && !isApprovedLeave) ab++;
                });

                document.getElementById('sd-stat-present').innerText = p;
                document.getElementById('sd-stat-late').innerText = late;
                document.getElementById('sd-stat-leave').innerText = l;
                document.getElementById('sd-stat-absent').innerText = ab;
                
                // Render Detail Charts
                if(window.sdChartPie instanceof Chart) window.sdChartPie.destroy();
                if(window.sdChartLine instanceof Chart) window.sdChartLine.destroy();
                
                const ctxP = document.getElementById('sdChartPie').getContext('2d');
                const total = p + late + l + ab;
                const dataP = total === 0 ? [1] : [p, late, l, ab];
                const colsP = total === 0 ? ['#eee'] : ['#4ade80', '#facc15', '#fb923c', '#f87171'];

                window.sdChartPie = new Chart(ctxP, {
                    type: 'doughnut',
                    data: { labels: ['มา', 'สาย', 'ลา', 'ขาด'], datasets: [{ data: dataP, backgroundColor: colsP, borderWidth: 0 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 10 } } } }
                });
                
                const ctxL = document.getElementById('sdChartLine').getContext('2d');
                // Mock line data based on history
                window.sdChartLine = new Chart(ctxL, {
                    type: 'line',
                    data: { labels: ['1', '2', '3', '4'], datasets: [{ label: 'สถานะ', data: [1, 1, 1, 0], borderColor: '#667eea', tension: 0.3 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { display: false } } }
                });

                const tb = document.getElementById('sd-history-body'); tb.innerHTML = '';
                const allLeaves = DB.getLeaves().filter(l => l.student_id === id);
                [...att, ...allLeaves].sort((a,b) => new Date(b.check_in_time||b.date) - new Date(a.check_in_time||a.date)).forEach(r => {
                     const isAtt = !!r.check_in_time;
                     const d = new Date(isAtt ? r.check_in_time : r.date);
                     
                     // Filter by date range
                     const dStr = d.toISOString().split('T')[0];
                     if(type === 'monthly' && !dStr.startsWith(m.value)) return;
                     if(type === 'yearly' && !dStr.startsWith(y.value)) return;

                     let st = '-', col = 'text-gray-500', bg = 'bg-gray-100';
                     if (isAtt) {
                         st = r.check_in_status === 'late' ? 'มาสาย' : 'ทันเวลา';
                         col = r.check_in_status === 'late' ? 'text-yellow-700' : 'text-green-700';
                         bg = r.check_in_status === 'late' ? 'bg-yellow-100' : 'bg-green-100';
                     } else {
                         if(r.leave_status === 'approved') { st = 'ลา (อนุมัติ)'; col = 'text-orange-700'; bg = 'bg-orange-100'; }
                         else if(r.leave_status === 'rejected') { st = 'ลา (ปฏิเสธ)'; col = 'text-red-700 line-through'; bg = 'bg-red-100'; }
                         else { st = 'ลา (รอ)'; col = 'text-gray-600'; bg = 'bg-gray-200'; }
                     }
                     tb.innerHTML += `<tr><td class="p-3 border-b border-gray-50">${d.toLocaleDateString('th-TH', {day:'numeric', month:'short'})}</td><td class="p-3 border-b border-gray-50 font-mono text-gray-500">${isAtt ? d.toLocaleTimeString('th-TH', {hour:'2-digit',minute:'2-digit'}) : '-'}</td><td class="p-3 border-b border-gray-50"><span class="px-2 py-1 rounded text-[10px] font-bold ${col} ${bg}">${st}</span></td></tr>`;
                });
            },
            searchStudent() {
                const q = document.getElementById('search-input').value.toLowerCase();
                const res = document.getElementById('search-results'); res.innerHTML = '';
                if(!q) return;
                DB.getStudents().filter(s => s.student_name.toLowerCase().includes(q) || s.student_id.includes(q)).forEach(s => {
                    res.innerHTML += `<div class="bg-white p-3 rounded mb-2 shadow-sm border flex justify-between items-center cursor-pointer hover:bg-gray-50" onclick="teacherApp.loadStudentDetails('${s.student_id}')"><div><div class="font-bold text-sm">${s.student_name}</div><div class="text-xs text-gray-500">${s.student_id}</div></div><i class="fa-solid fa-chevron-right text-gray-300"></i></div>`;
                });
            },
            
            updateBadge() {
                const leaves = DB.getLeaves();
                const pendingCount = leaves.filter(l => l.leave_status === 'pending').length;
                const badge = document.getElementById('badge-leave-count');
                const badgeMobile = document.getElementById('badge-leave-mobile');
                if(badge) { badge.innerText = pendingCount; if(pendingCount > 0) badge.classList.remove('hidden'); else badge.classList.add('hidden'); }
                if(badgeMobile) { if(pendingCount > 0) badgeMobile.classList.remove('hidden'); else badgeMobile.classList.add('hidden'); }
            },
            
            toggleLock(id) {
                 const student = DB.getStudents().find(s => s.student_id === id);
                 if(student) {
                     const newState = !student.is_locked;
                     DB.updateRecord(s => s.student_id === id, s => ({...s, is_locked: newState}));
                     this.loadStudents();
                     if(this.currentViewingStudentId === id) this.loadStudentDetails(id);
                     Swal.fire({ icon: 'success', title: newState ? 'ล็อคบัญชีแล้ว' : 'ปลดล็อคแล้ว', toast: true, position: 'top-end', showConfirmButton: false, timer: 1000 });
                 }
            },
            
            deleteStudent(id) {
                Swal.fire({ title: 'ยืนยันการลบ?', text: "ข้อมูลจะหายไปถาวร", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'ลบเลย' }).then((result) => {
                    if(result.isConfirmed) {
                        const db = DB.getAll(); 
                        const newArray = db.filter(r => !(r.type === 'registration' && r.student_id === id));
                        DB.save(newArray);
                        this.loadStudents();
                        if(this.currentViewingStudentId === id) this.closeStudentDetails();
                        Swal.fire('ลบเรียบร้อย', '', 'success');
                    }
                });
            },
            
            loadLeaves() {
                const leaves = DB.getLeaves();
                const listPending = document.getElementById('leave-pending-list');
                const listHistory = document.getElementById('leave-history-list');
                listPending.innerHTML = ''; listHistory.innerHTML = '';
                this.updateBadge();
                const pendingLeaves = leaves.filter(l => l.leave_status === 'pending');
                if (pendingLeaves.length === 0) listPending.innerHTML = '<div class="text-center text-gray-400 py-4 text-sm">ไม่มีคำร้องรออนุมัติ</div>';
                pendingLeaves.forEach((l) => {
                    const div = document.createElement('div');
                    div.className = 'bg-white p-3 rounded-lg border border-gray-200 shadow-sm';
                    div.innerHTML = `<div class="flex justify-between mb-1"><span class="font-bold text-sm text-brand">${l.student_name} <span class="text-xs text-gray-400 font-normal">(${l.student_id})</span></span><span class="text-xs text-gray-400">${l.date}</span></div><p class="text-xs text-gray-600 mb-2 bg-gray-50 p-2 rounded">"${l.leave_reason}"</p><div class="flex gap-2"><button onclick="teacherApp.approveLeave('${l.requested_at}', true)" class="flex-1 bg-green-50 text-green-600 text-xs py-1.5 rounded font-bold hover:bg-green-100 transition">อนุมัติ</button><button onclick="teacherApp.approveLeave('${l.requested_at}', false)" class="flex-1 bg-red-50 text-red-600 text-xs py-1.5 rounded font-bold hover:bg-red-100 transition">ไม่อนุมัติ</button></div>`;
                    listPending.appendChild(div);
                });
                const historyLeaves = leaves.filter(l => l.leave_status !== 'pending').reverse().slice(0, 20);
                historyLeaves.forEach(l => {
                    const div = document.createElement('div');
                    const statusColor = l.leave_status === 'approved' ? 'text-green-500' : 'text-red-500';
                    const statusText = l.leave_status === 'approved' ? 'อนุมัติ' : 'ไม่อนุมัติ';
                    div.className = 'bg-white p-3 rounded-lg border border-gray-100 shadow-sm flex justify-between items-center opacity-80';
                    div.innerHTML = `<div><div class="text-sm font-bold text-gray-700">${l.student_name}</div><div class="text-xs text-gray-400">${l.date} • ${l.leave_reason}</div></div><div class="text-xs font-bold ${statusColor}">${statusText}</div>`;
                    listHistory.appendChild(div);
                });
            },
            
            approveLeave(reqAt, isApproved) {
                 DB.updateRecord(l => l.requested_at === reqAt, l => ({ ...l, leave_status: isApproved ? 'approved' : 'rejected' }));
                 this.loadLeaves(); this.loadOverview();
                 Swal.fire({ icon: isApproved ? 'success' : 'info', title: isApproved ? 'อนุมัติคำร้องแล้ว' : 'ปฏิเสธคำร้องแล้ว', toast: true, position: 'top-end', showConfirmButton: false, timer: 1500 });
            }
        };

        window.addEventListener('load', () => {
            seedData();
            const logo = localStorage.getItem('app_custom_logo');
            if(logo) document.getElementById('app-logo').src = logo;
            router.navigateTo('landing');
        });
        
        window.onerror = function(msg, url, line) {
            console.error("Global Error:", msg);
        };
    </script>
</body>
</html>
